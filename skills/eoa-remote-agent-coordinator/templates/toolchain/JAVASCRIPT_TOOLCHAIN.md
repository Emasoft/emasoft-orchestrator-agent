# JavaScript/TypeScript Toolchain Template

Extends: `BASE_TOOLCHAIN.md`
Package Manager: bun (preferred), pnpm, or npm
Preferred for: Web apps, Node.js services, Electron

---

## Quick Reference

| Component | Tool | Version | Install |
|-----------|------|---------|---------|
| Runtime | bun / node | 1.1+ / 20+ | curl / nvm |
| Package Manager | bun / pnpm | bundled / 9+ | curl / npm |
| Formatter | prettier | latest | bun add -D |
| Linter | eslint | 9+ | bun add -D |
| Type Checker | typescript | 5.4+ | bun add -D |
| Test Runner | vitest / bun test | latest | bun add -D |
| Bundler | bun build / vite | bundled / latest | bun add -D |

---

## Variable Substitutions

```yaml
LANGUAGE: typescript
LANGUAGE_VERSION: "5.4"
LANGUAGE_CMD: tsc
LANGUAGE_VERSION_CMD: "bun run tsc --version"
LANGUAGE_INSTALL_CMD: |
  curl -fsSL https://bun.sh/install | bash

PACKAGE_MANAGER: bun
PACKAGE_MANAGER_VERSION: "1.1+"
PACKAGE_MANAGER_INSTALL_CMD: |
  curl -fsSL https://bun.sh/install | bash
  source "$HOME/.bun/env"
INSTALL_DEPS_CMD: "bun install"

FORMATTER: prettier
FORMATTER_CMD: "bun run prettier --check ."
FORMATTER_CONFIG: ".prettierrc"

LINTER: eslint
LINTER_CMD: "bun run eslint src/"
LINTER_CONFIG: "eslint.config.js"

TYPE_CHECKER: typescript
TYPE_CHECKER_CMD: "bun run tsc --noEmit"
TYPE_CHECKER_CONFIG: "tsconfig.json"

TEST_RUNNER: vitest
TEST_CMD: "bun run vitest run"
COVERAGE_CMD: "bun run vitest run --coverage"

BUILD_COMMAND: "bun run build"
VERIFY_ALL_CMD: "bun run tsc --noEmit && bun run eslint src/ && bun run vitest run"

CONFIG_FILES_LIST: "package.json, tsconfig.json, eslint.config.js, .prettierrc"
```

---

## Setup Script (Compiled)

```bash
#!/bin/bash
# JavaScript/TypeScript Toolchain Setup for {{PROJECT_NAME}}
# Task: {{TASK_ID}}
# Generated by emasoft-orchestrator-agent

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# ============================================================
# STEP 1: Install Bun
# ============================================================

if ! command -v bun &>/dev/null; then
  log_info "Installing Bun..."
  curl -fsSL https://bun.sh/install | bash

  # Add to PATH
  export BUN_INSTALL="$HOME/.bun"
  export PATH="$BUN_INSTALL/bin:$PATH"

  # Source for current session
  if [ -f "$HOME/.bun/env" ]; then
    source "$HOME/.bun/env"
  fi
else
  log_info "Bun already installed"
fi

log_info "Bun version: $(bun --version)"

# ============================================================
# STEP 2: Initialize Project (if needed)
# ============================================================

if [ ! -f "package.json" ]; then
  log_info "Initializing project..."
  bun init -y
fi

# ============================================================
# STEP 3: Install Dependencies
# ============================================================

log_info "Installing dependencies..."
bun install

# Install dev dependencies
log_info "Installing development tools..."
bun add -D typescript @types/node vitest prettier eslint @eslint/js typescript-eslint

# ============================================================
# STEP 4: Create Config Files (if missing)
# ============================================================

if [ ! -f "tsconfig.json" ]; then
  log_info "Creating tsconfig.json..."
  cat > tsconfig.json << 'EOF'
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022"],
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "coverage"]
}
EOF
fi

if [ ! -f "eslint.config.js" ]; then
  log_info "Creating eslint.config.js..."
  cat > eslint.config.js << 'EOF'
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.strictTypeChecked,
  ...tseslint.configs.stylisticTypeChecked,
  {
    languageOptions: {
      parserOptions: {
        project: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
    rules: {
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
      '@typescript-eslint/explicit-function-return-type': 'warn',
      '@typescript-eslint/no-explicit-any': 'error',
    },
  },
  {
    ignores: ['dist/**', 'coverage/**', 'node_modules/**'],
  }
);
EOF
fi

if [ ! -f ".prettierrc" ]; then
  log_info "Creating .prettierrc..."
  cat > .prettierrc << 'EOF'
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "bracketSpacing": true,
  "arrowParens": "always"
}
EOF
fi

if [ ! -f "vitest.config.ts" ]; then
  log_info "Creating vitest.config.ts..."
  cat > vitest.config.ts << 'EOF'
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'dist/', '**/*.config.*'],
    },
  },
});
EOF
fi

# ============================================================
# STEP 5: Create Directory Structure
# ============================================================

mkdir -p src tests

if [ ! -f "src/index.ts" ]; then
  echo '// Entry point' > src/index.ts
fi

# ============================================================
# STEP 6: Update package.json scripts
# ============================================================

log_info "Updating package.json scripts..."

# Use bun to update package.json
bun run --bun -e "
const pkg = require('./package.json');
pkg.type = 'module';
pkg.scripts = {
  ...pkg.scripts,
  'build': 'bun build src/index.ts --outdir dist --target node',
  'typecheck': 'tsc --noEmit',
  'lint': 'eslint src/',
  'lint:fix': 'eslint src/ --fix',
  'format': 'prettier --write .',
  'format:check': 'prettier --check .',
  'test': 'vitest run',
  'test:watch': 'vitest',
  'test:coverage': 'vitest run --coverage'
};
require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
" 2>/dev/null || log_warn "Could not update package.json scripts automatically"

# ============================================================
# STEP 7: Verify Installation
# ============================================================

log_info "Verifying toolchain..."

verify_tool() {
  local name="$1"
  local cmd="$2"
  if eval "$cmd" &>/dev/null; then
    log_info "[OK] $name"
  else
    log_error "[FAIL] $name"
    return 1
  fi
}

verify_tool "bun" "bun --version"
verify_tool "typescript" "bun run tsc --version"
verify_tool "eslint" "bun run eslint --version"
verify_tool "prettier" "bun run prettier --version"
verify_tool "vitest" "bun run vitest --version"

echo ""
log_info "=========================================="
log_info "TypeScript toolchain setup complete!"
log_info ""
log_info "Verification commands:"
log_info "  bun run typecheck      - Type check"
log_info "  bun run lint           - Run linter"
log_info "  bun run format:check   - Check formatting"
log_info "  bun run test           - Run tests"
log_info ""
log_info "Full verification:"
log_info "  bun run typecheck && bun run lint && bun run test"
log_info "=========================================="
```

---

## package.json Template

```json
{
  "name": "{{PROJECT_NAME}}",
  "version": "0.1.0",
  "type": "module",
  "description": "{{DESCRIPTION}}",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "bun build src/index.ts --outdir dist --target node",
    "typecheck": "tsc --noEmit",
    "lint": "eslint src/",
    "lint:fix": "eslint src/ --fix",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage"
  },
  "devDependencies": {
    "@eslint/js": "^9.0.0",
    "@types/node": "^20.0.0",
    "eslint": "^9.0.0",
    "prettier": "^3.0.0",
    "typescript": "^5.4.0",
    "typescript-eslint": "^8.0.0",
    "vitest": "^2.0.0"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

---

## GitHub Actions CI Template

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run typecheck

      - name: Lint
        run: bun run lint

      - name: Format check
        run: bun run format:check

      - name: Test
        run: bun run test

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run coverage
        run: bun run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

---

## Library Requirements (MANDATORY)

| Purpose | Library | Usage |
|---------|---------|-------|
| JSON | native `JSON` | `JSON.stringify()`, `JSON.parse()` |
| CLI | `commander` | `program.option()` |
| HTTP | `fetch` (native) | `fetch()`, `Response` |
| Schema | `zod` | Type-safe validation |
| Paths | `node:path` | `path.join()` |
| FS | `node:fs/promises` | `fs.readFile()` |

**VIOLATIONS (will fail review):**
- Template literals for JSON: `` `{"key": "${value}"}` ``
- `any` type usage
- Missing return types on functions
- `require()` instead of `import`
- Callback-style async (use async/await)

---

## Verification Checklist

```markdown
## TypeScript Toolchain Verification - {{TASK_ID}}

### Installation
- [ ] bun installed: `bun --version`
- [ ] TypeScript installed: `bun run tsc --version`
- [ ] ESLint installed: `bun run eslint --version`
- [ ] Prettier installed: `bun run prettier --version`

### Configuration
- [ ] package.json has type: "module"
- [ ] tsconfig.json exists with strict mode
- [ ] eslint.config.js exists (flat config)
- [ ] .prettierrc exists
- [ ] vitest.config.ts exists

### Verification Commands Pass
- [ ] `bun run typecheck` - no type errors
- [ ] `bun run lint` - no linting errors
- [ ] `bun run format:check` - formatting correct
- [ ] `bun run test` - all tests pass

### CI/CD
- [ ] .github/workflows/ci.yml exists
- [ ] Uses `oven-sh/setup-bun@v2`
- [ ] Matrix includes: ubuntu, macos, windows
- [ ] Coverage job configured

### EOA Compliance
- [ ] Labels configured in GitHub
- [ ] Branch follows convention
- [ ] Commits follow convention
```
