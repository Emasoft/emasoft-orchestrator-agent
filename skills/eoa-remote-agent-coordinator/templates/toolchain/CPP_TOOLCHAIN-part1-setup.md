# C/C++ Toolchain - Part 1: Setup Script

**Parent document**: [CPP_TOOLCHAIN.md](CPP_TOOLCHAIN.md)

---

## Setup Script (Compiled)

```bash
#!/bin/bash
# C++ Toolchain Setup for {{PROJECT_NAME}}
# Task: {{TASK_ID}}
# Generated by atlas-orchestrator

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

PLATFORM="$(uname -s)"

# ============================================================
# STEP 1: Detect Platform and Install Compiler
# ============================================================

install_toolchain_macos() {
  log_info "Installing Xcode Command Line Tools..."
  xcode-select --install 2>/dev/null || log_info "Xcode CLT already installed"

  log_info "Installing LLVM and CMake via Homebrew..."
  brew install llvm cmake ninja

  # Add LLVM to PATH
  export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
}

install_toolchain_linux() {
  log_info "Installing build essentials..."
  sudo apt update
  sudo apt install -y \
    build-essential \
    gcc-11 g++-11 \
    clang-14 clang-format-14 clang-tidy-14 \
    cmake ninja-build \
    libstdc++-11-dev

  # Set default versions
  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 110
  sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 110
  sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 140
  sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 140
}

install_toolchain_windows() {
  log_error "Windows setup requires manual installation:"
  log_error "1. Install Visual Studio 2022 with C++ Desktop Development"
  log_error "2. Or install Build Tools: https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2022"
  log_error "3. Install CMake: winget install Kitware.CMake"
  log_error "4. Run this script from 'Developer Command Prompt for VS 2022'"
  exit 1
}

case "$PLATFORM" in
  Darwin)
    install_toolchain_macos
    ;;
  Linux)
    install_toolchain_linux
    ;;
  MINGW*|MSYS*|CYGWIN*)
    install_toolchain_windows
    ;;
  *)
    log_error "Unsupported platform: $PLATFORM"
    exit 1
    ;;
esac

# ============================================================
# STEP 2: Verify Compiler Installation
# ============================================================

log_info "Verifying compilers..."
g++ --version | head -1
clang++ --version | head -1
cmake --version | head -1

# ============================================================
# STEP 3: Install Conan (Package Manager)
# ============================================================

if ! command -v conan &>/dev/null; then
  log_info "Installing Conan..."
  pip install "conan>=2.0"
fi

conan --version

# Initialize Conan profile
if [ ! -f "$HOME/.conan2/profiles/default" ]; then
  log_info "Creating default Conan profile..."
  conan profile detect --force
fi

# ============================================================
# STEP 4: Install Development Tools
# ============================================================

log_info "Installing clang-format and clang-tidy..."

case "$PLATFORM" in
  Darwin)
    # Already installed via llvm
    ;;
  Linux)
    sudo apt install -y clang-format-14 clang-tidy-14
    sudo ln -sf /usr/bin/clang-format-14 /usr/bin/clang-format
    sudo ln -sf /usr/bin/clang-tidy-14 /usr/bin/clang-tidy
    ;;
esac

# ============================================================
# STEP 5: Create Config Files (if missing)
# ============================================================

if [ ! -f ".clang-format" ]; then
  log_info "Creating .clang-format..."
  cat > .clang-format << 'EOF'
# Clang-Format Configuration
# ATLAS-orchestrator standard config
---
Language: Cpp
BasedOnStyle: LLVM
Standard: c++20

# Line length
ColumnLimit: 100

# Indentation
IndentWidth: 4
UseTab: Never
IndentCaseLabels: true
IndentPPDirectives: BeforeHash

# Braces
BreakBeforeBraces: Attach
AllowShortFunctionsOnASingleLine: Inline
AllowShortIfStatementsOnASingleLine: Never
AllowShortLoopsOnASingleLine: false

# Alignment
AlignConsecutiveAssignments: false
AlignConsecutiveDeclarations: false
AlignOperands: true
AlignTrailingComments: true

# Spacing
SpaceAfterCStyleCast: false
SpaceBeforeParens: ControlStatements
SpacesInParentheses: false
SpacesInSquareBrackets: false

# Include sorting
SortIncludes: CaseSensitive
IncludeBlocks: Regroup
IncludeCategories:
  - Regex:           '^".*"'
    Priority:        1
  - Regex:           '^<.*\.h>'
    Priority:        2
  - Regex:           '^<.*>'
    Priority:        3

# Pointers and references
DerivePointerAlignment: false
PointerAlignment: Left
ReferenceAlignment: Left
EOF
fi

if [ ! -f ".clang-tidy" ]; then
  log_info "Creating .clang-tidy..."
  cat > .clang-tidy << 'EOF'
# Clang-Tidy Configuration
# ATLAS-orchestrator standard config
---
Checks: >
  -*,
  bugprone-*,
  clang-analyzer-*,
  cppcoreguidelines-*,
  modernize-*,
  performance-*,
  readability-*,
  -readability-magic-numbers,
  -cppcoreguidelines-avoid-magic-numbers,
  -modernize-use-trailing-return-type

WarningsAsErrors: '*'

HeaderFilterRegex: '(src|include)/.*\.h$'

CheckOptions:
  - key: readability-identifier-naming.ClassCase
    value: CamelCase
  - key: readability-identifier-naming.FunctionCase
    value: camelCase
  - key: readability-identifier-naming.VariableCase
    value: camelBack
  - key: readability-identifier-naming.ConstantCase
    value: UPPER_CASE
  - key: cppcoreguidelines-special-member-functions.AllowSoleDefaultDtor
    value: 1
EOF
fi

# ============================================================
# STEP 6: Verify Installation
# ============================================================

log_info "Verifying toolchain..."

verify_tool() {
  local name="$1"
  local cmd="$2"
  if eval "$cmd" &>/dev/null; then
    log_info "[OK] $name"
  else
    log_error "[FAIL] $name"
    return 1
  fi
}

verify_tool "g++" "g++ --version"
verify_tool "cmake" "cmake --version"
verify_tool "conan" "conan --version"
verify_tool "clang-format" "clang-format --version"
verify_tool "clang-tidy" "clang-tidy --version"

echo ""
log_info "=========================================="
log_info "C++ toolchain setup complete!"
log_info ""
log_info "Next steps:"
log_info "  1. Create CMakeLists.txt"
log_info "  2. Create conanfile.txt or vcpkg.json"
log_info "  3. Run: conan install . --build=missing"
log_info "  4. Run: cmake -S . -B build"
log_info "  5. Run: cmake --build build"
log_info ""
log_info "Verification commands:"
log_info "  cmake --build build          - Build project"
log_info "  ctest --test-dir build       - Run tests"
log_info "  clang-tidy src/*.cpp         - Run linter"
log_info "  clang-format -i src/*.cpp    - Format code"
log_info "=========================================="
```
