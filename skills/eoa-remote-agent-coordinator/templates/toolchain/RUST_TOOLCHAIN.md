# Rust Toolchain Template

Extends: `BASE_TOOLCHAIN.md`
Package Manager: cargo (via rustup)
Preferred for: CLI tools, systems programming, WASM

---

## Quick Reference

| Component | Tool | Version | Install |
|-----------|------|---------|---------|
| Language | rustc | stable/1.75+ | rustup |
| Package Manager | cargo | bundled | rustup |
| Formatter | rustfmt | bundled | `rustup component add rustfmt` |
| Linter | clippy | bundled | `rustup component add clippy` |
| Test Runner | cargo test | bundled | - |
| Coverage | cargo-tarpaulin | latest | `cargo install cargo-tarpaulin` |

---

## Variable Substitutions

```yaml
LANGUAGE: rust
LANGUAGE_VERSION: stable
LANGUAGE_CMD: rustc
LANGUAGE_VERSION_CMD: "rustc --version"
LANGUAGE_INSTALL_CMD: |
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source "$HOME/.cargo/env"

PACKAGE_MANAGER: cargo
PACKAGE_MANAGER_VERSION: bundled
PACKAGE_MANAGER_INSTALL_CMD: "# Included with rustup"
INSTALL_DEPS_CMD: "cargo fetch"

FORMATTER: rustfmt
FORMATTER_CMD: "cargo fmt"
FORMATTER_CONFIG: "rustfmt.toml"

LINTER: clippy
LINTER_CMD: "cargo clippy -- -D warnings"
LINTER_CONFIG: ".clippy.toml"

TYPE_CHECKER: "-"
TYPE_CHECKER_CMD: "# Rust is statically typed"
TYPE_CHECKER_CONFIG: "-"

TEST_RUNNER: "cargo test"
TEST_CMD: "cargo test --all-features"
COVERAGE_CMD: "cargo tarpaulin --out Html --output-dir coverage/"

BUILD_COMMAND: "cargo build --release"
VERIFY_ALL_CMD: "cargo test && cargo clippy -- -D warnings && cargo fmt --check"

CONFIG_FILES_LIST: "Cargo.toml, rustfmt.toml, .clippy.toml"
```

---

## Setup Script (Compiled)

```bash
#!/bin/bash
# Rust Toolchain Setup for {{PROJECT_NAME}}
# Task: {{TASK_ID}}
# Generated by atlas-orchestrator

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# ============================================================
# STEP 1: Install Rust via rustup
# ============================================================

if ! command -v rustc &>/dev/null; then
  log_info "Installing Rust..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source "$HOME/.cargo/env"
else
  log_info "Rust already installed"
fi

# Update to stable
rustup default stable
rustup update stable

# ============================================================
# STEP 2: Install Components
# ============================================================

log_info "Installing rustfmt and clippy..."
rustup component add rustfmt clippy

# ============================================================
# STEP 3: Install Additional Tools
# ============================================================

log_info "Installing cargo-tarpaulin (coverage)..."
cargo install cargo-tarpaulin --locked || log_warn "cargo-tarpaulin install failed (optional)"

# Install cargo-edit for dependency management (optional)
cargo install cargo-edit --locked 2>/dev/null || true

# ============================================================
# STEP 4: Verify Installation
# ============================================================

log_info "Verifying toolchain..."

verify_tool() {
  local name="$1"
  local cmd="$2"
  if $cmd &>/dev/null; then
    log_info "[OK] $name"
  else
    log_error "[FAIL] $name"
    return 1
  fi
}

verify_tool "rustc" "rustc --version"
verify_tool "cargo" "cargo --version"
verify_tool "rustfmt" "rustfmt --version"
verify_tool "clippy" "cargo clippy --version"

# ============================================================
# STEP 5: Create Config Files (if missing)
# ============================================================

if [ ! -f "rustfmt.toml" ]; then
  log_info "Creating rustfmt.toml..."
  cat > rustfmt.toml << 'EOF'
# Rust Formatter Configuration
# ATLAS-orchestrator standard config

edition = "2021"
max_width = 100
tab_spaces = 4
newline_style = "Unix"
use_small_heuristics = "Default"

# Imports
imports_granularity = "Crate"
group_imports = "StdExternalCrate"
reorder_imports = true

# Comments
wrap_comments = true
comment_width = 80
normalize_comments = true

# Other
format_code_in_doc_comments = true
format_macro_matchers = true
format_strings = true
EOF
fi

if [ ! -f ".clippy.toml" ]; then
  log_info "Creating .clippy.toml..."
  cat > .clippy.toml << 'EOF'
# Clippy Configuration
# ATLAS-orchestrator standard config

# Cognitive complexity threshold
cognitive-complexity-threshold = 25

# Array size threshold for stack allocation warning
array-size-threshold = 512000

# Too many arguments threshold
too-many-arguments-threshold = 7
EOF
fi

# ============================================================
# STEP 6: Cargo.toml Recommendations
# ============================================================

if [ -f "Cargo.toml" ]; then
  log_info "Checking Cargo.toml for recommended dependencies..."

  # Check for serde_json (MANDATORY for JSON)
  if ! grep -q 'serde_json' Cargo.toml; then
    log_warn "Missing serde_json - add: serde_json = \"1\""
  fi

  # Check for clap (MANDATORY for CLI)
  if ! grep -q 'clap' Cargo.toml; then
    log_warn "Missing clap - add: clap = { version = \"4\", features = [\"derive\"] }"
  fi
fi

echo ""
log_info "=========================================="
log_info "Rust toolchain setup complete!"
log_info ""
log_info "Verification commands:"
log_info "  cargo test           - Run tests"
log_info "  cargo clippy         - Run linter"
log_info "  cargo fmt --check    - Check formatting"
log_info "  cargo tarpaulin      - Run coverage"
log_info ""
log_info "Full verification:"
log_info "  cargo test && cargo clippy -- -D warnings && cargo fmt --check"
log_info "=========================================="
```

---

## Cargo.toml Template

```toml
[package]
name = "{{PROJECT_NAME}}"
version = "0.1.0"
edition = "2021"
authors = ["{{AUTHOR}}"]
description = "{{DESCRIPTION}}"
license = "MIT"
repository = "https://github.com/{{GITHUB_OWNER}}/{{PROJECT_NAME}}"

[dependencies]
# JSON serialization (MANDATORY - never use manual string formatting)
serde = { version = "1", features = ["derive"] }
serde_json = "1"

# CLI argument parsing (MANDATORY for CLI apps)
clap = { version = "4", features = ["derive"] }

# Error handling
anyhow = "1"
thiserror = "1"

[dev-dependencies]
# Testing
assert_cmd = "2"
predicates = "3"

[profile.release]
lto = true
codegen-units = 1
strip = true

[lints.rust]
unsafe_code = "forbid"

[lints.clippy]
all = "warn"
pedantic = "warn"
nursery = "warn"
```

---

## GitHub Actions CI Template

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --verbose --all-features

      - name: Run tests
        run: cargo test --verbose --all-features

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: cargo tarpaulin --out Xml --output-dir coverage/

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage/cobertura.xml
```

---

## Library Requirements (MANDATORY)

| Purpose | Library | Usage |
|---------|---------|-------|
| JSON | `serde_json` | `serde_json::to_string()`, `serde_json::from_str()` |
| CLI | `clap` | `#[derive(Parser)]` |
| HTTP | `reqwest` | `reqwest::Client::new()` |
| Async | `tokio` | `#[tokio::main]` |
| Errors | `anyhow` / `thiserror` | `anyhow::Result<T>` |
| Logging | `tracing` | `tracing::info!()` |

**VIOLATIONS (will fail review):**
- `format!("{}", value)` for JSON output
- Manual argument parsing without clap
- `println!` for structured output (use serde)
- `unwrap()` in library code (use `?`)

---

## Cross-Platform Considerations

### macOS (Intel + ARM)
```toml
# Cargo.toml - universal binary
[target.'cfg(target_os = "macos")']
# No special deps needed, but test on both architectures
```

### Windows
```toml
[target.'cfg(windows)']
# Windows-specific dependencies if needed
```

### Linux
```toml
[target.'cfg(target_os = "linux")']
# Linux-specific dependencies if needed
```

---

## Verification Checklist

```markdown
## Rust Toolchain Verification - {{TASK_ID}}

### Installation
- [ ] rustc installed: `rustc --version` shows stable
- [ ] cargo installed: `cargo --version`
- [ ] rustfmt installed: `rustfmt --version`
- [ ] clippy installed: `cargo clippy --version`

### Configuration
- [ ] rustfmt.toml exists with ATLAS standard config
- [ ] .clippy.toml exists with ATLAS standard config
- [ ] Cargo.toml has serde_json dependency
- [ ] Cargo.toml has clap dependency (for CLI)

### Verification Commands Pass
- [ ] `cargo build` - compiles without errors
- [ ] `cargo test` - all tests pass
- [ ] `cargo clippy -- -D warnings` - no warnings
- [ ] `cargo fmt --check` - formatting correct

### CI/CD
- [ ] .github/workflows/ci.yml exists
- [ ] Uses `dtolnay/rust-toolchain@stable` (NOT rust-action)
- [ ] Matrix includes: ubuntu, macos, windows
- [ ] Coverage job configured

### ATLAS Compliance
- [ ] Labels configured in GitHub
- [ ] Branch follows convention: `feature/{{TASK_ID}}-*`
- [ ] Commits follow convention: `feat({{TASK_ID}}): *`
```
