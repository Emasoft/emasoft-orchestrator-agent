# Python Toolchain Template

Extends: `BASE_TOOLCHAIN.md`
Package Manager: uv (preferred) or pip
Preferred for: Scripts, ML, data processing, automation

---

## Quick Reference

| Component | Tool | Version | Install |
|-----------|------|---------|---------|
| Language | python | 3.12+ | uv python install |
| Package Manager | uv | 0.4+ | curl install |
| Formatter | ruff format | bundled | uv pip install ruff |
| Linter | ruff check | bundled | uv pip install ruff |
| Type Checker | mypy | latest | uv pip install mypy |
| Test Runner | pytest | latest | uv pip install pytest |
| Coverage | pytest-cov | latest | uv pip install pytest-cov |

---

## Variable Substitutions

```yaml
LANGUAGE: python
LANGUAGE_VERSION: "3.12"
LANGUAGE_CMD: python3
LANGUAGE_VERSION_CMD: "python3 --version"
LANGUAGE_INSTALL_CMD: |
  uv python install 3.12

PACKAGE_MANAGER: uv
PACKAGE_MANAGER_VERSION: "0.4+"
PACKAGE_MANAGER_INSTALL_CMD: |
  curl -LsSf https://astral.sh/uv/install.sh | sh
  source "$HOME/.local/bin/env"
INSTALL_DEPS_CMD: "uv pip install -e '.[dev]'"

FORMATTER: ruff
FORMATTER_CMD: "uv run ruff format src/ tests/"
FORMATTER_CONFIG: "pyproject.toml [tool.ruff]"

LINTER: ruff
LINTER_CMD: "uv run ruff check src/ tests/"
LINTER_CONFIG: "pyproject.toml [tool.ruff]"

TYPE_CHECKER: mypy
TYPE_CHECKER_CMD: "uv run mypy src/"
TYPE_CHECKER_CONFIG: "pyproject.toml [tool.mypy]"

TEST_RUNNER: pytest
TEST_CMD: "uv run pytest tests/ -v"
COVERAGE_CMD: "uv run pytest tests/ --cov=src --cov-report=html"

BUILD_COMMAND: "uv build"
VERIFY_ALL_CMD: "uv run pytest && uv run ruff check src/ && uv run mypy src/ && uv run ruff format --check src/"

CONFIG_FILES_LIST: "pyproject.toml, .python-version"
```

---

## Setup Script (Compiled)

```bash
#!/bin/bash
# Python Toolchain Setup for {{PROJECT_NAME}}
# Task: {{TASK_ID}}
# Generated by atlas-orchestrator

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# ============================================================
# STEP 1: Install uv (Astral's fast Python package manager)
# ============================================================

if ! command -v uv &>/dev/null; then
  log_info "Installing uv..."
  curl -LsSf https://astral.sh/uv/install.sh | sh

  # Add to PATH
  export PATH="$HOME/.local/bin:$PATH"

  # Source for current session
  if [ -f "$HOME/.local/bin/env" ]; then
    source "$HOME/.local/bin/env"
  fi
else
  log_info "uv already installed"
fi

log_info "uv version: $(uv --version)"

# ============================================================
# STEP 2: Install Python 3.12
# ============================================================

log_info "Installing Python 3.12..."
uv python install 3.12

# Create .python-version file
echo "3.12" > .python-version

# ============================================================
# STEP 3: Create Virtual Environment
# ============================================================

if [ ! -d ".venv" ]; then
  log_info "Creating virtual environment..."
  uv venv --python 3.12
fi

# Activate venv
source .venv/bin/activate

# ============================================================
# STEP 4: Install Dependencies
# ============================================================

log_info "Installing project dependencies..."

# If pyproject.toml exists, install from it
if [ -f "pyproject.toml" ]; then
  uv pip install -e ".[dev]" || uv pip install -e .
else
  log_warn "No pyproject.toml found, creating minimal one..."
  # Will be created in Step 5
fi

# Install dev tools explicitly
log_info "Installing development tools..."
uv pip install ruff mypy pytest pytest-cov

# ============================================================
# STEP 5: Create Config Files (if missing)
# ============================================================

if [ ! -f "pyproject.toml" ]; then
  log_info "Creating pyproject.toml..."
  cat > pyproject.toml << 'EOF'
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "{{PROJECT_NAME}}"
version = "0.1.0"
description = "{{DESCRIPTION}}"
readme = "README.md"
license = "MIT"
requires-python = ">=3.12"
authors = [
    { name = "{{AUTHOR}}", email = "{{AUTHOR_EMAIL}}" }
]
dependencies = []

[project.optional-dependencies]
dev = [
    "ruff>=0.4.0",
    "mypy>=1.10.0",
    "pytest>=8.0.0",
    "pytest-cov>=5.0.0",
]

[project.scripts]
# {{PROJECT_NAME}} = "{{PROJECT_NAME}}.cli:main"

[tool.ruff]
target-version = "py312"
line-length = 88
src = ["src", "tests"]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "UP",     # pyupgrade
    "ARG",    # flake8-unused-arguments
    "SIM",    # flake8-simplify
]
ignore = [
    "E501",   # line too long (handled by formatter)
]

[tool.ruff.lint.isort]
known-first-party = ["{{PROJECT_NAME}}"]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

[tool.mypy]
python_version = "3.12"
strict = true
warn_return_any = true
warn_unused_ignores = true
disallow_untyped_defs = true
disallow_incomplete_defs = true

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_functions = ["test_*"]
addopts = "-v --tb=short"

[tool.coverage.run]
source = ["src"]
branch = true

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "raise NotImplementedError",
]
EOF
fi

# ============================================================
# STEP 6: Create Directory Structure
# ============================================================

mkdir -p src/{{PROJECT_NAME_SNAKE}} tests

if [ ! -f "src/{{PROJECT_NAME_SNAKE}}/__init__.py" ]; then
  touch src/{{PROJECT_NAME_SNAKE}}/__init__.py
fi

if [ ! -f "tests/__init__.py" ]; then
  touch tests/__init__.py
fi

# ============================================================
# STEP 7: Verify Installation
# ============================================================

log_info "Verifying toolchain..."

verify_tool() {
  local name="$1"
  local cmd="$2"
  if $cmd &>/dev/null; then
    log_info "[OK] $name"
  else
    log_error "[FAIL] $name"
    return 1
  fi
}

verify_tool "python" "python3 --version"
verify_tool "uv" "uv --version"
verify_tool "ruff" "uv run ruff --version"
verify_tool "mypy" "uv run mypy --version"
verify_tool "pytest" "uv run pytest --version"

echo ""
log_info "=========================================="
log_info "Python toolchain setup complete!"
log_info ""
log_info "Activate venv: source .venv/bin/activate"
log_info ""
log_info "Verification commands:"
log_info "  uv run pytest tests/        - Run tests"
log_info "  uv run ruff check src/      - Run linter"
log_info "  uv run mypy src/            - Type check"
log_info "  uv run ruff format src/     - Format code"
log_info ""
log_info "Full verification:"
log_info "  uv run pytest && uv run ruff check src/ && uv run mypy src/"
log_info "=========================================="
```

---

## pyproject.toml Template

See the full template in the setup script above (Step 5).

---

## GitHub Actions CI Template

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Check formatting
        run: uv run ruff format --check src/ tests/

      - name: Run linter
        run: uv run ruff check src/ tests/

      - name: Type check
        run: uv run mypy src/

      - name: Run tests
        run: uv run pytest tests/ -v

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run coverage
        run: uv run pytest tests/ --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage.xml
```

---

## Library Requirements (MANDATORY)

| Purpose | Library | Usage |
|---------|---------|-------|
| JSON | `json` (stdlib) | `json.dumps()`, `json.loads()` |
| CLI | `argparse` (stdlib) or `click` | `argparse.ArgumentParser()` |
| HTTP | `httpx` | `httpx.get()`, `httpx.Client()` |
| Async | `asyncio` | `async def`, `await` |
| Data | `pydantic` | Type validation |
| Paths | `pathlib` | `Path()` not `os.path` |

**VIOLATIONS (will fail review):**
- f-strings for JSON: `f'{{"key": "{value}"}}'`
- `os.path` instead of `pathlib`
- `requests` (use `httpx` instead)
- `print()` for structured output (use json.dumps)
- Missing type hints

---

## Verification Checklist

```markdown
## Python Toolchain Verification - {{TASK_ID}}

### Installation
- [ ] uv installed: `uv --version`
- [ ] Python 3.12: `python3 --version`
- [ ] venv exists: `.venv/` directory
- [ ] venv activated: `which python` shows `.venv`

### Configuration
- [ ] pyproject.toml exists with ATLAS standard config
- [ ] .python-version file exists (contains "3.12")
- [ ] src/ directory exists
- [ ] tests/ directory exists

### Verification Commands Pass
- [ ] `uv run ruff format --check src/` - formatting correct
- [ ] `uv run ruff check src/` - no linting errors
- [ ] `uv run mypy src/` - type check passes
- [ ] `uv run pytest tests/` - all tests pass

### CI/CD
- [ ] .github/workflows/ci.yml exists
- [ ] Uses `astral-sh/setup-uv@v4`
- [ ] Matrix includes: ubuntu, macos, windows
- [ ] Coverage job configured

### ATLAS Compliance
- [ ] Labels configured in GitHub
- [ ] Branch follows convention
- [ ] Commits follow convention
```
