# Go Toolchain - Part 1: Setup Script

**Parent**: [GO_TOOLCHAIN.md](./GO_TOOLCHAIN.md)

This file contains the complete bash setup script for initializing a Go development environment.

---

## Setup Script (Compiled)

```bash
#!/bin/bash
# Go Toolchain Setup for {{PROJECT_NAME}}
# Task: {{TASK_ID}}
# Generated by emasoft-orchestrator-agent

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# ============================================================
# STEP 1: Install Go 1.22+
# ============================================================

if ! command -v go &>/dev/null; then
  log_info "Installing Go..."

  # Detect OS and install
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    if command -v brew &>/dev/null; then
      brew install go
    else
      log_error "Homebrew not found. Install from: https://golang.org/dl/"
      exit 1
    fi
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    if command -v apt &>/dev/null; then
      sudo apt update
      sudo apt install -y golang
    elif command -v yum &>/dev/null; then
      sudo yum install -y golang
    else
      log_error "Package manager not found. Install from: https://golang.org/dl/"
      exit 1
    fi
  elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
    # Windows
    if command -v winget &>/dev/null; then
      winget install GoLang.Go
    else
      log_error "winget not found. Install from: https://golang.org/dl/"
      exit 1
    fi
  else
    log_error "Unsupported OS: $OSTYPE"
    exit 1
  fi
else
  log_info "Go already installed"
fi

GO_VERSION=$(go version)
log_info "Go version: $GO_VERSION"

# Verify minimum version
REQUIRED_VERSION="1.22"
INSTALLED_VERSION=$(go version | grep -oE '[0-9]+\.[0-9]+' | head -1)

if [[ "$(printf '%s\n' "$REQUIRED_VERSION" "$INSTALLED_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]]; then
  log_error "Go version $INSTALLED_VERSION is below required $REQUIRED_VERSION"
  exit 1
fi

# ============================================================
# STEP 2: Configure GOPATH and GOBIN
# ============================================================

export GOPATH="${GOPATH:-$HOME/go}"
export GOBIN="${GOBIN:-$GOPATH/bin}"
export PATH="$GOBIN:$PATH"

log_info "GOPATH: $GOPATH"
log_info "GOBIN: $GOBIN"

# Add to shell profile if not present
SHELL_RC="$HOME/.bashrc"
if [[ "$SHELL" == *"zsh"* ]]; then
  SHELL_RC="$HOME/.zshrc"
fi

if ! grep -q "export GOPATH=" "$SHELL_RC" 2>/dev/null; then
  log_info "Adding Go paths to $SHELL_RC"
  cat >> "$SHELL_RC" << 'EOF'

# Go configuration
export GOPATH="${GOPATH:-$HOME/go}"
export GOBIN="${GOBIN:-$GOPATH/bin}"
export PATH="$GOBIN:$PATH"
EOF
fi

# ============================================================
# STEP 3: Initialize Go Module
# ============================================================

if [ ! -f "go.mod" ]; then
  log_info "Initializing Go module..."

  # Extract module path from project name
  MODULE_PATH="github.com/{{GITHUB_OWNER}}/{{PROJECT_NAME}}"
  go mod init "$MODULE_PATH"

  log_info "Created go.mod with module: $MODULE_PATH"
else
  log_info "go.mod already exists"
fi

# ============================================================
# STEP 4: Install Development Tools
# ============================================================

log_info "Installing golangci-lint..."
if ! command -v golangci-lint &>/dev/null; then
  curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "$GOBIN" latest
else
  log_info "golangci-lint already installed"
fi

log_info "golangci-lint version: $(golangci-lint --version)"

# ============================================================
# STEP 5: Create Directory Structure
# ============================================================

log_info "Creating standard Go project structure..."

mkdir -p cmd/{{PROJECT_NAME}}
mkdir -p pkg
mkdir -p internal
mkdir -p test

# Create main.go if it doesn't exist
if [ ! -f "cmd/{{PROJECT_NAME}}/main.go" ]; then
  log_info "Creating cmd/{{PROJECT_NAME}}/main.go..."
  cat > "cmd/{{PROJECT_NAME}}/main.go" << 'EOF'
package main

import (
	"fmt"
	"os"
)

func main() {
	if err := run(); err != nil {
		fmt.Fprintf(os.Stderr, "Error: %v\n", err)
		os.Exit(1)
	}
}

func run() error {
	fmt.Println("{{PROJECT_NAME}} starting...")
	return nil
}
EOF
fi

# ============================================================
# STEP 6: Create Configuration Files
# ============================================================

if [ ! -f ".golangci.yml" ]; then
  log_info "Creating .golangci.yml..."
  cat > .golangci.yml << 'EOF'
# golangci-lint configuration for EOA projects
run:
  timeout: 5m
  tests: true
  modules-download-mode: readonly

linters:
  enable:
    - errcheck      # Check for unchecked errors
    - gosimple      # Simplify code
    - govet         # Vet examines Go source code
    - ineffassign   # Detect ineffectual assignments
    - staticcheck   # Static analysis
    - unused        # Check for unused code
    - gofmt         # Enforce standard formatting
    - goimports     # Ensure correct imports
    - misspell      # Find misspellings
    - revive        # Drop-in replacement for golint
    - gosec         # Security issues
    - unconvert     # Unnecessary type conversions
    - gocritic      # Most opinionated linter
    - goprintffuncname  # Check printf function names
    - nolintlint    # Ensure nolint directives are valid

linters-settings:
  govet:
    check-shadowing: true
  gofmt:
    simplify: true
  goimports:
    local-prefixes: github.com/{{GITHUB_OWNER}}/{{PROJECT_NAME}}
  revive:
    rules:
      - name: var-naming
        disabled: false
      - name: package-comments
        disabled: false
      - name: exported
        disabled: false

issues:
  exclude-use-default: false
  max-issues-per-linter: 0
  max-same-issues: 0

  # Exclude test files from certain lints
  exclude-rules:
    - path: _test\.go
      linters:
        - errcheck
        - gosec
EOF
fi

# ============================================================
# STEP 7: Download Dependencies
# ============================================================

log_info "Downloading dependencies..."
go mod download
go mod tidy

# ============================================================
# STEP 8: Verify Installation
# ============================================================

log_info "Verifying toolchain..."

verify_tool() {
  local name="$1"
  local cmd="$2"
  if eval "$cmd" &>/dev/null; then
    log_info "[OK] $name"
  else
    log_error "[FAIL] $name"
    return 1
  fi
}

verify_tool "go" "go version"
verify_tool "go fmt" "go fmt -h"
verify_tool "go vet" "go vet -h"
verify_tool "go test" "go test -h"
verify_tool "golangci-lint" "golangci-lint --version"

# Build test
log_info "Testing build..."
if go build -o /tmp/{{PROJECT_NAME}}_test ./cmd/{{PROJECT_NAME}}; then
  log_info "[OK] Build successful"
  rm -f /tmp/{{PROJECT_NAME}}_test
else
  log_error "[FAIL] Build failed"
  exit 1
fi

echo ""
log_info "=========================================="
log_info "Go toolchain setup complete!"
log_info ""
log_info "Verification commands:"
log_info "  go test ./...               - Run tests"
log_info "  go test ./... -race         - Run with race detector"
log_info "  go test ./... -cover        - Run with coverage"
log_info "  go vet ./...                - Static analysis"
log_info "  golangci-lint run ./...     - Full linting"
log_info "  go fmt ./...                - Format code"
log_info ""
log_info "Build command:"
log_info "  go build -o bin/{{PROJECT_NAME}} ./cmd/{{PROJECT_NAME}}"
log_info ""
log_info "Full verification:"
log_info "  go fmt ./... && go vet ./... && golangci-lint run ./... && go test ./... -race -cover"
log_info "=========================================="
```

---

## Script Sections Reference

| Section | Lines | Purpose |
|---------|-------|---------|
| Step 1 | Install Go | Installs Go 1.22+ based on OS detection |
| Step 2 | Configure Paths | Sets GOPATH, GOBIN, updates shell profile |
| Step 3 | Init Module | Creates go.mod with correct module path |
| Step 4 | Install Tools | Installs golangci-lint |
| Step 5 | Create Structure | Creates cmd/, pkg/, internal/, test/ |
| Step 6 | Create Configs | Creates .golangci.yml with EOA settings |
| Step 7 | Download Deps | Runs go mod download and tidy |
| Step 8 | Verify | Tests all tools and performs test build |
