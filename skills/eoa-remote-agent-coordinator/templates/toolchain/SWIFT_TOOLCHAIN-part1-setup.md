# Swift Toolchain - Part 1: Setup & Variables

**Parent Document:** [SWIFT_TOOLCHAIN.md](./SWIFT_TOOLCHAIN.md)

---

## Variable Substitutions

```yaml
LANGUAGE: swift
LANGUAGE_VERSION: "5.9"
LANGUAGE_CMD: swift
LANGUAGE_VERSION_CMD: "swift --version"
LANGUAGE_INSTALL_CMD_MACOS: |
  # Install Xcode Command Line Tools
  xcode-select --install 2>/dev/null || true
  # Verify installation
  xcodebuild -version

LANGUAGE_INSTALL_CMD_LINUX: |
  # Install swiftly (Swift version manager for Linux)
  curl -L https://swift-server.github.io/swiftly/swiftly-install.sh | bash
  source ~/.local/share/swiftly/env.sh
  swiftly install latest
  swiftly use latest

PACKAGE_MANAGER: swift-package
PACKAGE_MANAGER_VERSION: bundled
PACKAGE_MANAGER_INSTALL_CMD: "# Included with Swift"
INSTALL_DEPS_CMD: "swift package resolve"

FORMATTER: swift-format
FORMATTER_CMD: "swift package plugin --allow-writing-to-package-directory format"
FORMATTER_CONFIG: ".swift-format"

LINTER: swiftlint
LINTER_CMD: "swiftlint lint --strict"
LINTER_CONFIG: ".swiftlint.yml"

TYPE_CHECKER: "-"
TYPE_CHECKER_CMD: "# Swift is statically typed"
TYPE_CHECKER_CONFIG: "-"

TEST_RUNNER: "swift test"
TEST_CMD: "swift test --parallel"
COVERAGE_CMD: "swift test --enable-code-coverage && xcrun llvm-cov show .build/debug/{{PACKAGE_NAME}}PackageTests.xctest/Contents/MacOS/{{PACKAGE_NAME}}PackageTests -instr-profile .build/debug/codecov/default.profdata"

BUILD_COMMAND: "swift build -c release"
BUILD_COMMAND_XCODE: "xcodebuild -scheme {{SCHEME_NAME}} -configuration Release"
VERIFY_ALL_CMD: "swift build && swift test && swiftlint lint --strict"

CONFIG_FILES_LIST: "Package.swift, .swift-format, .swiftlint.yml"
```

---

## Setup Script (Compiled)

```bash
#!/bin/bash
# Swift Toolchain Setup for {{PROJECT_NAME}}
# Task: {{TASK_ID}}
# Generated by emasoft-orchestrator-agent

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# ============================================================
# STEP 1: Detect Platform
# ============================================================

PLATFORM=$(uname -s)
log_info "Detected platform: $PLATFORM"

# ============================================================
# STEP 2: Install Swift
# ============================================================

install_swift_macos() {
  log_info "Installing Swift via Xcode Command Line Tools..."

  # Check if Xcode CLT is installed
  if ! xcode-select -p &>/dev/null; then
    log_info "Installing Xcode Command Line Tools..."
    xcode-select --install
    log_warn "Please complete the installation dialog, then re-run this script"
    exit 0
  fi

  log_info "Xcode Command Line Tools already installed"
  xcodebuild -version || true
}

install_swift_linux() {
  log_info "Installing Swift via swiftly..."

  if ! command -v swiftly &>/dev/null; then
    curl -L https://swift-server.github.io/swiftly/swiftly-install.sh | bash
    source ~/.local/share/swiftly/env.sh || source ~/.swiftly/env.sh
  fi

  swiftly install latest
  swiftly use latest
}

if ! command -v swift &>/dev/null; then
  case "$PLATFORM" in
    Darwin)
      install_swift_macos
      ;;
    Linux)
      install_swift_linux
      ;;
    *)
      log_error "Unsupported platform: $PLATFORM"
      exit 1
      ;;
  esac
else
  log_info "Swift already installed"
fi

# Verify Swift version
SWIFT_VERSION=$(swift --version 2>&1 | head -1)
log_info "Swift version: $SWIFT_VERSION"

# ============================================================
# STEP 3: Install Development Tools
# ============================================================

install_tools_macos() {
  log_info "Installing development tools for macOS..."

  # Install Homebrew if not present
  if ! command -v brew &>/dev/null; then
    log_warn "Homebrew not found. Install from https://brew.sh"
    return 1
  fi

  # Install SwiftLint
  if ! command -v swiftlint &>/dev/null; then
    log_info "Installing swiftlint..."
    brew install swiftlint
  else
    log_info "swiftlint already installed"
  fi

  # Install swift-format (via SwiftPM plugin or standalone)
  log_info "swift-format will be available via SwiftPM plugin"
}

install_tools_linux() {
  log_info "Installing development tools for Linux..."

  # SwiftLint on Linux requires building from source or using pre-built binary
  log_warn "SwiftLint not available on Linux by default"
  log_info "swift-format will be available via SwiftPM plugin"
}

case "$PLATFORM" in
  Darwin)
    install_tools_macos
    ;;
  Linux)
    install_tools_linux
    ;;
esac

# ============================================================
# STEP 4: Verify Installation
# ============================================================

log_info "Verifying toolchain..."

verify_tool() {
  local name="$1"
  local cmd="$2"
  if eval "$cmd" &>/dev/null; then
    log_info "[OK] $name"
  else
    log_warn "[SKIP] $name (optional or platform-specific)"
    return 0
  fi
}

verify_tool "swift" "swift --version"
verify_tool "swift package" "swift package --version"
verify_tool "swiftlint" "swiftlint version"

# ============================================================
# STEP 5: Create Config Files (if missing)
# ============================================================

if [ ! -f ".swift-format" ]; then
  log_info "Creating .swift-format..."
  cat > .swift-format << 'EOF'
{
  "version": 1,
  "lineLength": 100,
  "indentation": {
    "spaces": 2
  },
  "respectsExistingLineBreaks": true,
  "lineBreakBeforeControlFlowKeywords": false,
  "lineBreakBeforeEachArgument": false,
  "lineBreakBeforeEachGenericRequirement": false,
  "prioritizeKeepingFunctionOutputTogether": true,
  "indentConditionalCompilationBlocks": true,
  "indentSwitchCaseLabels": false,
  "fileScopedDeclarationPrivacy": {
    "accessLevel": "private"
  },
  "rules": {
    "AllPublicDeclarationsHaveDocumentation": false,
    "AlwaysUseLowerCamelCase": true,
    "AmbiguousTrailingClosureOverload": true,
    "BeginDocumentationCommentWithOneLineSummary": false,
    "DoNotUseSemicolons": true,
    "DontRepeatTypeInStaticProperties": true,
    "FileScopedDeclarationPrivacy": true,
    "FullyIndirectEnum": true,
    "GroupNumericLiterals": true,
    "IdentifiersMustBeASCII": true,
    "NeverForceUnwrap": true,
    "NeverUseForceTry": true,
    "NeverUseImplicitlyUnwrappedOptionals": true,
    "NoAccessLevelOnExtensionDeclaration": true,
    "NoBlockComments": true,
    "NoCasesWithOnlyFallthrough": true,
    "NoEmptyTrailingClosureParentheses": true,
    "NoLabelsInCasePatterns": true,
    "NoLeadingUnderscores": false,
    "NoParensAroundConditions": true,
    "NoVoidReturnOnFunctionSignature": true,
    "OneCasePerLine": true,
    "OneVariableDeclarationPerLine": true,
    "OnlyOneTrailingClosureArgument": true,
    "OrderedImports": true,
    "ReturnVoidInsteadOfEmptyTuple": true,
    "UseLetInEveryBoundCaseVariable": true,
    "UseShorthandTypeNames": true,
    "UseSingleLinePropertyGetter": true,
    "UseSynthesizedInitializer": true,
    "UseTripleSlashForDocumentationComments": true,
    "ValidateDocumentationComments": false
  }
}
EOF
fi

if [ ! -f ".swiftlint.yml" ]; then
  log_info "Creating .swiftlint.yml..."
  cat > .swiftlint.yml << 'EOF'
# SwiftLint Configuration
# EOA standard config

disabled_rules:
  - trailing_whitespace
  - todo

opt_in_rules:
  - array_init
  - attributes
  - closure_end_indentation
  - closure_spacing
  - collection_alignment
  - contains_over_first_not_nil
  - empty_count
  - empty_string
  - fatal_error_message
  - first_where
  - force_unwrapping
  - implicitly_unwrapped_optional
  - last_where
  - literal_expression_end_indentation
  - modifier_order
  - multiline_arguments
  - multiline_function_chains
  - multiline_literal_brackets
  - multiline_parameters
  - operator_usage_whitespace
  - overridden_super_call
  - pattern_matching_keywords
  - prefer_self_type_over_type_of_self
  - redundant_nil_coalescing
  - redundant_type_annotation
  - sorted_first_last
  - toggle_bool
  - trailing_closure
  - unneeded_parentheses_in_closure_argument
  - vertical_parameter_alignment_on_call
  - yoda_condition

included:
  - Sources
  - Tests

excluded:
  - .build
  - .swiftpm
  - DerivedData

line_length:
  warning: 120
  error: 150
  ignores_comments: true

file_length:
  warning: 500
  error: 1000

type_body_length:
  warning: 300
  error: 500

function_body_length:
  warning: 50
  error: 100

cyclomatic_complexity:
  warning: 10
  error: 20

identifier_name:
  min_length:
    warning: 2
  max_length:
    warning: 40
    error: 50
  excluded:
    - id
    - url
    - URL
EOF
fi

# ============================================================
# STEP 6: Package.swift Recommendations
# ============================================================

if [ -f "Package.swift" ]; then
  log_info "Checking Package.swift..."

  # Check for ArgumentParser (CLI apps)
  if ! grep -q 'swift-argument-parser' Package.swift; then
    log_warn "Consider adding swift-argument-parser for CLI: .package(url: \"https://github.com/apple/swift-argument-parser.git\", from: \"1.3.0\")"
  fi

  # Check for plugins (swift-format)
  if ! grep -q 'swift-format' Package.swift; then
    log_warn "Consider adding swift-format plugin: .package(url: \"https://github.com/apple/swift-format.git\", from: \"509.0.0\")"
  fi
else
  log_warn "Package.swift not found - run 'swift package init' to create a new package"
fi

echo ""
log_info "=========================================="
log_info "Swift toolchain setup complete!"
log_info ""
log_info "Verification commands:"
log_info "  swift build          - Build package"
log_info "  swift test           - Run tests"
log_info "  swiftlint lint       - Run linter"
log_info "  swift package plugin format --check  - Check formatting"
log_info ""
log_info "Full verification:"
log_info "  swift build && swift test && swiftlint lint --strict"
log_info "=========================================="
```

---

**Next:** [Part 2 - Templates](./SWIFT_TOOLCHAIN-part2-templates.md)
